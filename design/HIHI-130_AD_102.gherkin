Feature: Encrypt PII data in customer_360_raw_clone table

  Background:
    Given a connection to the Databricks environment
    And the table purgo_playground.customer_360_raw_clone exists
    And the table purgo_playground.customer_360_raw_clone12 does not exist

  Scenario: Prepare the environment
    Given I drop the table purgo_playground.customer_360_raw_clone12 if it exists
    When I create a replica of purgo_playground.customer_360_raw as purgo_playground.customer_360_raw_clone12
    Then the table purgo_playground.customer_360_raw_clone12 should exist with the same schema as purgo_playground.customer_360_raw

  Scenario Outline: Encrypt PII data
    Given I connect to the purgo_playground.customer_360_raw_clone12 table
    When I encrypt the "<column>" column using AES-256 encryption
    Then the "<column>" column should be encrypted
    And an encryption key should be generated and saved as JSON
    And the file should be named encryption_key_<current_datetime>.json
    And the file should be stored in /Volumes/agilisium_playground/purgo_playground/de_dq12

    Examples:
      | column  |
      | name    |
      | email   |
      | phone   |
      | zip     |

  Scenario: Validate PII encryption process
    Given I connect to the purgo_playground.customer_360_raw_clone12 table
    When I validate the encryption key has been saved securely
    Then the encryption key file should exist in the specified volume location
    And the file should follow the JSON format with structure {"key": "<encrypted_key_value>"}

  Scenario: Handle missing columns during encryption
    Given I connect to the purgo_playground.customer_360_raw_clone12 table
    When I attempt to encrypt a non-existent column "<column>"
    Then an error should be thrown
    And the error message should read "Column <column> does not exist"

    Examples:
      | column     |
      | salary     |
      | birth_date |

  Scenario: Error handling during encryption failure
    Given I simulate a failure in the encryption process
    When the encryption process fails
    Then an error should be logged
    And the error message should be "Encryption failed due to system error"

  Scenario: Validate data integrity post-encryption
    Given I connect to the purgo_playground.customer_360_raw_clone12 table
    When I retrieve encrypted data from the "<column>" column
    Then the data should be unreadable without decryption

    Examples:
      | column  |
      | name    |
      | email   |
      | phone   |
      | zip     |

